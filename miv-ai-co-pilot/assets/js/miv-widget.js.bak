(function () {
  const backendUrl =
    window.MIV_WIDGET_CONFIG && window.MIV_WIDGET_CONFIG.backendUrl;

  if (!backendUrl) {
    console.error("MIV backendUrl not provided");
    return;
  }

  let fontScale = 1;
  let highContrast = false;
  let isLoading = false;

  // Intent state
  let intent = null;

  // Keep your original 4 quick questions (they’ll be used under the right intent)
  const QUICK_QUESTIONS = [
    "How do I make sure my online forms are accessible?",
    "What tools can help someone with low vision use my digital content more easily?",
    "How do I make my event more accessible for people with different disabilities?",
    "Can you help me find tools to support people with hearing impairments?"
  ];

  const INTENT_CATEGORIES = [
    { key: "digital", label: "Digital accessibility" },
    { key: "events", label: "Events & venues" },
    { key: "tools", label: "Tools & assistive tech" },
    { key: "supports", label: "Disability supports" },
    { key: "other", label: "Something else" }
  ];

  // Prompt sets (includes your 4 original questions, now targeted)
  const PROMPTS_BY_INTENT = {
    digital: [
      QUICK_QUESTIONS[0],
      "How can I test my website for accessibility?",
      "What colour contrast rules should I follow?",
      "How do I write good alt text?"
    ],
    events: [
      QUICK_QUESTIONS[2],
      "What should I include on an accessible registration form?",
      "How can I support sensory needs at an event?",
      "What are low-cost accessibility improvements?"
    ],
    tools: [
      QUICK_QUESTIONS[3],
      QUICK_QUESTIONS[1],
      "What are common assistive technologies I should know about?",
      "Are there free accessibility tools available?"
    ],
    supports: [
      "How can I support someone with a disability in the workplace?",
      "What adjustments help people with ADHD or autism?",
      "How do I make my communication more accessible?",
      "What does inclusive language look like?"
    ],
    other: [
      "Help me figure out what I should focus on first.",
      "What are the most common accessibility barriers?",
      "Can you review my situation and suggest next steps?",
      "Where do I start with inclusive design?"
    ]
  };

  const root = document.getElementById("miv-widget-root");
  if (!root) return;

  const launcherBtn = document.getElementById("miv-launcher-btn");
  const chatWindow = document.getElementById("miv-chat-window");
  const closeBtn = document.getElementById("miv-close-btn");

  const a11yToggle = document.getElementById("miv-a11y-toggle");
  const a11yPanel = document.getElementById("miv-a11y-panel");
  const a11yClose = document.getElementById("miv-a11y-close");

  const fontDec = document.getElementById("miv-font-dec");
  const fontInc = document.getElementById("miv-font-inc");
  const contrastToggle = document.getElementById("miv-contrast-toggle");

  const messagesEl = document.getElementById("miv-messages");
  const form = document.getElementById("miv-form");
  const input = document.getElementById("miv-user-input");

  /* -----------------------------
     Quick Questions UI (dynamic)
  ----------------------------- */
  const quickWrap = document.createElement("div");
  quickWrap.className = "miv-quick-questions";
  chatWindow.insertBefore(quickWrap, messagesEl);

  function clearQuickArea() {
    quickWrap.innerHTML = "";
    quickWrap.style.display = "flex";
  }

  function renderTitle(text) {
    const title = document.createElement("div");
    title.className = "miv-quick-title"; // optional CSS class
    title.textContent = text;
    quickWrap.appendChild(title);
  }

  function renderIntentButtons() {
    clearQuickArea();
    renderTitle("What can I help you with today?");

    INTENT_CATEGORIES.forEach(cat => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "miv-chip";
      btn.innerHTML = `<span class="miv-chip-text">${cat.label}</span>`;

      btn.addEventListener("click", () => {
        intent = cat.key;
        addMessage(
          "assistant",
          `Got it — ${cat.label}. Pick a quick question above, or type your own.`
        );
        renderQuickQuestions(PROMPTS_BY_INTENT[intent] || QUICK_QUESTIONS);
      });

      quickWrap.appendChild(btn);
    });
  }

  function renderQuickQuestions(questions) {
    clearQuickArea();
    renderTitle("Quick questions:");

    (questions || []).slice(0, 4).forEach(q => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "miv-chip";
      btn.innerHTML = `<span class="miv-chip-text">${q}</span>`;

      btn.addEventListener("click", () => {
        input.value = "";
        sendMessage(q);
      });

      quickWrap.appendChild(btn);
    });

    // Change topic button
    const reset = document.createElement("button");
    reset.type = "button";
    reset.className = "miv-chip miv-chip--secondary";
    reset.innerHTML = `<span class="miv-chip-text">Change topic</span>`;
    reset.addEventListener("click", () => {
      intent = null;
      renderIntentButtons();
    });
    quickWrap.appendChild(reset);
  }

  /* -----------------------------
     Rendering helpers (ChatGPT-style)
  ----------------------------- */
  function addMessage(role, text) {
    const wrapper = document.createElement("div");
    wrapper.className = "miv-message miv-message--" + role;

    const lines = (text || "")
      .split("\n")
      .map(l => l.trim())
      .filter(Boolean);

    let listEl = null;

    lines.forEach(line => {
      if (line.startsWith("## ")) {
        const h = document.createElement("h4");
        h.textContent = line.replace(/^##\s*/, "");
        wrapper.appendChild(h);
        listEl = null;
        return;
      }

      if (line.startsWith("### ")) {
        const h = document.createElement("h5");
        h.textContent = line.replace(/^###\s*/, "");
        wrapper.appendChild(h);
        listEl = null;
        return;
      }

      if (line.startsWith("- ") || line.startsWith("• ")) {
        if (!listEl || listEl.tagName !== "UL") {
          listEl = document.createElement("ul");
          wrapper.appendChild(listEl);
        }
        const li = document.createElement("li");
        li.textContent = line.replace(/^[-•]\s*/, "");
        listEl.appendChild(li);
        return;
      }

      if (/^\d+\.\s+/.test(line)) {
        if (!listEl || listEl.tagName !== "OL") {
          listEl = document.createElement("ol");
          wrapper.appendChild(listEl);
        }
        const li = document.createElement("li");
        li.textContent = line.replace(/^\d+\.\s+/, "");
        listEl.appendChild(li);
        return;
      }

      listEl = null;
      const p = document.createElement("p");
      p.textContent = line;
      wrapper.appendChild(p);
    });

    messagesEl.appendChild(wrapper);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function addTypingIndicator() {
    const wrapper = document.createElement("div");
    wrapper.className =
      "miv-message miv-message--assistant miv-message--typing";
    wrapper.id = "miv-typing";

    for (let i = 0; i < 3; i++) {
      const dot = document.createElement("span");
      dot.className = "miv-dot";
      wrapper.appendChild(dot);
    }

    messagesEl.appendChild(wrapper);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function removeTypingIndicator() {
    const el = document.getElementById("miv-typing");
    if (el) el.remove();
  }

  /* -----------------------------
     Accessibility controls
  ----------------------------- */
  function applyFontScale() {
    chatWindow.style.setProperty("--miv-font-scale", fontScale.toString());
  }

  function applyContrast() {
    chatWindow.classList.toggle("miv-chat-window--high-contrast", highContrast);
    contrastToggle.setAttribute("aria-pressed", highContrast);
  }

  /* -----------------------------
     Chat controls
  ----------------------------- */
  function openChat() {
    chatWindow.classList.add("miv-chat-window--open");
    chatWindow.setAttribute("aria-hidden", "false");
    launcherBtn.style.display = "none";
    input.focus();
  }

  function closeChat() {
    chatWindow.classList.remove("miv-chat-window--open");
    chatWindow.setAttribute("aria-hidden", "true");
    launcherBtn.style.display = "";
  }

  async function sendMessage(text) {
    if (!text || isLoading) return;
    isLoading = true;

    // Hide chips once the user starts interacting
    quickWrap.style.display = "none";

    addMessage("user", text);
    addTypingIndicator();

    try {
      const res = await fetch(backendUrl + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: text, top_k: 3 })
      });

      const data = await res.json();
      removeTypingIndicator();
      addMessage(
        "assistant",
        (data && data.response) || "I couldn’t generate a response just now."
      );
    } catch (err) {
      console.error(err);
      removeTypingIndicator();
      addMessage("assistant", "I ran into a technical issue talking to the server.");
    } finally {
      isLoading = false;
    }
  }

  /* -----------------------------
     Event listeners
  ----------------------------- */
  launcherBtn.addEventListener("click", openChat);
  closeBtn.addEventListener("click", closeChat);

  a11yToggle.addEventListener("click", () => {
    a11yPanel.toggleAttribute("hidden");
  });

  a11yClose.addEventListener("click", () => {
    a11yPanel.setAttribute("hidden", "true");
  });

  fontDec.addEventListener("click", () => {
    fontScale = Math.max(0.9, fontScale - 0.1);
    applyFontScale();
  });

  fontInc.addEventListener("click", () => {
    fontScale = Math.min(1.2, fontScale + 0.1);
    applyFontScale();
  });

  contrastToggle.addEventListener("click", () => {
    highContrast = !highContrast;
    applyContrast();
  });

  form.addEventListener("submit", e => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    sendMessage(text);
  });

  /* -----------------------------
     Initial message + show intent UI
  ----------------------------- */
  addMessage(
    "assistant",
    "Ask me anything about accessibility, inclusive ventures, or supporting people with disabilities."
  );
  renderIntentButtons();

  applyFontScale();
  applyContrast();
})();
